#!/bin/ash

# Define config file path
X_CONFIG_FILE=/etc/sonic.cfg

# Assemble configuration file from environment variables if it does not exist
if [ ! -e "${X_CONFIG_FILE}" ]; then

  # Define error function for compact oneliners
  function error() { echo "ERROR: $@"; exit 1; }

  # Check needed variables
  [ -z ${SONIC_PASSWORD+x} ] && error "SONIC_PASSWORD is not defined."

  # Generate config in a quick and dirty way
  echo '[server]' > ${X_CONFIG_FILE}
  echo "log_level = \"${SONIC_LOGLEVEL:=info}\"" >> ${X_CONFIG_FILE}
  echo '
[channel]
inet = "0.0.0.0:1491"
tcp_timeout = 300' >> ${X_CONFIG_FILE}
  echo "auth_password = \"${SONIC_PASSWORD}\"" >> ${X_CONFIG_FILE}
  echo '
[channel.search]
query_limit_default = 10
query_limit_maximum = 100
query_alternates_try = 4
suggest_limit_default = 5
suggest_limit_maximum = 20
list_limit_default = 100
list_limit_maximum = 500

[store]

[store.kv]
path = "/var/lib/sonic/store/kv/"
retain_word_objects = 1000

[store.kv.pool]
inactive_after = 1800

[store.kv.database]
flush_after = 900
compress = true
parallelism = 2
max_files = 100
max_compactions = 1
max_flushes = 1
write_buffer = 16384
write_ahead_log = true

[store.fst]
path = "/var/lib/sonic/store/fst/"

[store.fst.pool]
inactive_after = 300

[store.fst.graph]
consolidate_after = 180
max_size = 2048
max_words = 250000
' >> ${X_CONFIG_FILE}

fi # End config file generation

exec /usr/local/bin/sonic -c /etc/sonic.cfg
